// Medical Diagnostic System - Frontend JavaScript

// Configuration
// Use relative URL for API calls - works both locally and in production
const API_BASE_URL = window.location.origin;

// DOM Elements
const patientInput = document.getElementById('patientInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');
const retryBtn = document.getElementById('retryBtn');

const loadingSection = document.getElementById('loadingSection');
const resultsSection = document.getElementById('resultsSection');
const errorSection = document.getElementById('errorSection');
const resultsContent = document.getElementById('resultsContent');
const errorMessage = document.getElementById('errorMessage');

// State
let currentAnalysis = null;

// Event Listeners
analyzeBtn.addEventListener('click', handleAnalyze);
clearBtn.addEventListener('click', handleClear);
downloadBtn.addEventListener('click', handleDownload);
retryBtn.addEventListener('click', handleRetry);

// Allow Ctrl/Cmd+Enter to submit
patientInput.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        handleAnalyze();
    }
});

/**
 * Handle symptom analysis
 */
async function handleAnalyze() {
    const input = patientInput.value.trim();

    // Validate input
    if (!input) {
        showError('אנא תאר/י את התסמינים שלך / Please describe your symptoms');
        return;
    }

    if (input.length < 10) {
        showError('אנא ספק/י תיאור מפורט יותר / Please provide a more detailed description');
        return;
    }

    // Hide previous results/errors
    hideAllSections();

    // Show loading
    loadingSection.style.display = 'block';
    analyzeBtn.disabled = true;

    try {
        // Call API
        const response = await fetch(`${API_BASE_URL}/api/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                patient_input: input
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Analysis failed');
        }

        if (data.success) {
            currentAnalysis = {
                input: input,
                result: data.result,
                metadata: data.metadata
            };
            showResults(data.result);
        } else {
            throw new Error(data.error || 'Analysis failed');
        }

    } catch (error) {
        console.error('Analysis error:', error);
        showError(
            `שגיאה בניתוח / Analysis Error:\n${error.message}\n\n` +
            'ודא/י ש-API Server פועל / Ensure API server is running'
        );
    } finally {
        loadingSection.style.display = 'none';
        analyzeBtn.disabled = false;
    }
}

/**
 * Handle clear button
 */
function handleClear() {
    patientInput.value = '';
    currentAnalysis = null;
    hideAllSections();
    patientInput.focus();
}

/**
 * Handle retry button
 */
function handleRetry() {
    hideAllSections();
    patientInput.focus();
}

/**
 * Handle download report
 */
function handleDownload() {
    if (!currentAnalysis) return;

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `medical_report_${timestamp}.txt`;

    const content = [
        '=' .repeat(70),
        'MEDICAL DIAGNOSTIC REPORT',
        'דוח אבחון רפואי',
        '=' .repeat(70),
        '',
        'PATIENT INPUT / תיאור התסמינים:',
        '-'.repeat(70),
        currentAnalysis.input,
        '',
        '=' .repeat(70),
        '',
        'DIAGNOSTIC GUIDANCE / הנחיות אבחון:',
        '-'.repeat(70),
        currentAnalysis.result,
        '',
        '=' .repeat(70),
        '',
        'METADATA:',
        `Analysis Date: ${new Date(currentAnalysis.metadata.start_time).toLocaleString()}`,
        `Duration: ${currentAnalysis.metadata.duration_seconds.toFixed(2)} seconds`,
        '',
        '=' .repeat(70),
        '',
        'DISCLAIMER:',
        'This analysis is for educational purposes only.',
        'Always consult a licensed healthcare provider for medical diagnosis.',
        '',
        'Generated by Medical Diagnostic System v1.0.0',
        '=' .repeat(70)
    ].join('\n');

    // Create download
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

/**
 * Show results section
 */
function showResults(result) {
    hideAllSections();
    resultsContent.textContent = result;
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

/**
 * Show error section
 */
function showError(message) {
    hideAllSections();
    errorMessage.textContent = message;
    errorSection.style.display = 'block';
    errorSection.scrollIntoView({ behavior: 'smooth' });
}

/**
 * Hide all result sections
 */
function hideAllSections() {
    loadingSection.style.display = 'none';
    resultsSection.style.display = 'none';
    errorSection.style.display = 'none';
}

/**
 * Check API health on load
 */
async function checkAPIHealth() {
    try {
        const response = await fetch(`${API_BASE_URL}/health`);
        const data = await response.json();

        if (data.status === 'healthy') {
            console.log('✅ API is healthy');
        } else {
            console.warn('⚠️ API health check failed:', data);
        }
    } catch (error) {
        console.error('❌ Cannot connect to API:', error);
        showError(
            'לא ניתן להתחבר לשרת / Cannot connect to API server\n\n' +
            'אנא ודא/י ש-Backend Server פועל:\n' +
            'Please ensure Backend server is running:\n' +
            'python backend/api.py'
        );
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    console.log('Medical Diagnostic System initialized');
    checkAPIHealth();
    patientInput.focus();
});
